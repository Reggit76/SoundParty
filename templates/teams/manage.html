{% extends "base.html" %}
{% block title %}{{ page_title }} — Sound Party{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Главная</a></li>
    <li class="breadcrumb-item"><a href="/teams">Команды</a></li>
    <li class="breadcrumb-item"><a href="/teams/{{ team.team_id }}">{{ team.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Управление</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Уведомления -->
{% if request.query_params.get('success') == 'updated' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> Команда успешно обновлена!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% endif %}

{% if request.query_params.get('success') == 'member_removed' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> Участник удален из команды!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="fas fa-crown"></i> Управление командой
  </h1>
  <div>
    <a href="/teams/{{ team.team_id }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> К команде
    </a>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <!-- Основная информация команды -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-edit"></i> Редактирование команды</h5>
      </div>
      <div class="card-body">
        <form action="/teams/{{ team.team_id }}/update" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          
          <div class="mb-3">
            <label for="team_name" class="form-label">Название команды</label>
            <input type="text" class="form-control" id="team_name" name="team_name" 
                   value="{{ team.name }}" required>
          </div>
          
          <div class="mb-3">
            <label for="team_description" class="form-label">Описание команды</label>
            <textarea class="form-control" id="team_description" name="team_description" 
                      rows="3" placeholder="Краткое описание команды (необязательно)"></textarea>
            <small class="text-muted">Расскажите о своей команде, её целях и достижениях</small>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Текущий рейтинг</label>
                <input type="text" class="form-control" value="{{ team.rating }}" disabled>
                <small class="text-muted">Рейтинг изменяется автоматически по результатам мероприятий</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Количество участников</label>
                <input type="text" class="form-control" value="{{ team.participant_count }}" disabled>
              </div>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Сохранить изменения
          </button>
        </form>
      </div>
    </div>

    <!-- Управление участниками -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-users"></i> Управление участниками</h5>
        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#inviteModal">
          <i class="fas fa-user-plus"></i> Пригласить участника
        </button>
      </div>
      <div class="card-body">
        {% if team.participants %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Участник</th>
                  <th>Email</th>
                  <th>Роль</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for participant in team.participants %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="fas fa-user-circle fa-2x text-primary me-2"></i>
                      <div>
                        <strong>{{ participant.username }}</strong>
                        {% if participant.fullname %}
                          <br><small class="text-muted">{{ participant.fullname }}</small>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td>{{ participant.email }}</td>
                  <td>
                    {% if loop.index == 1 %}
                      <span class="badge bg-warning">
                        <i class="fas fa-crown"></i> Капитан
                      </span>
                    {% else %}
                      <span class="badge bg-info">Участник</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if loop.index != 1 %}
                      <button type="button" class="btn btn-sm btn-outline-danger" 
                              data-bs-toggle="modal" 
                              data-bs-target="#removeModal{{ participant.user_id }}">
                        <i class="fas fa-user-minus"></i> Удалить
                      </button>
                    {% else %}
                      <small class="text-muted">Нельзя удалить капитана</small>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">В команде пока только вы</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <!-- Статистика команды -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Статистика</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-6">
            <h3 class="text-primary">{{ team.rating }}</h3>
            <p class="text-muted mb-0">Рейтинг</p>
          </div>
          <div class="col-6">
            <h3 class="text-success">{{ team.participant_count }}</h3>
            <p class="text-muted mb-0">Участников</p>
          </div>
        </div>
        <hr>
        <div class="row text-center">
          <div class="col-6">
            <h3 class="text-info">0</h3>
            <p class="text-muted mb-0">Мероприятий</p>
          </div>
          <div class="col-6">
            <h3 class="text-warning">0</h3>
            <p class="text-muted mb-0">Побед</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Быстрые действия -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-bolt"></i> Быстрые действия</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/events" class="btn btn-outline-primary">
            <i class="fas fa-calendar-alt"></i> Найти мероприятия
          </a>
          <a href="/my-bookings" class="btn btn-outline-info">
            <i class="fas fa-clipboard-list"></i> Мои заявки
          </a>
          <a href="/rating" class="btn btn-outline-success">
            <i class="fas fa-trophy"></i> Рейтинг команд
          </a>
          <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteTeamModal">
            <i class="fas fa-trash"></i> Удалить команду
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно приглашения участника -->
<div class="modal fade" id="inviteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-envelope"></i> Пригласить участника
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="inviteForm" action="/teams/{{ team.team_id }}/invite" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          
          <div class="mb-3">
            <label for="invite_email" class="form-label">Email участника</label>
            <input type="email" class="form-control" id="invite_email" name="invite_email" required>
            <small class="text-muted">Введите email пользователя, которого хотите пригласить</small>
          </div>
          
          <div class="mb-3">
            <label for="invite_message" class="form-label">Сообщение (необязательно)</label>
            <textarea class="form-control" id="invite_message" name="invite_message" rows="3" 
                      placeholder="Персональное сообщение для приглашения"></textarea>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 
            Пользователь получит приглашение и сможет присоединиться к команде
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Отмена
        </button>
        <button type="submit" class="btn btn-primary" form="inviteForm">
          <i class="fas fa-paper-plane"></i> Отправить приглашение
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Модальные окна удаления участников -->
{% for participant in team.participants %}
  {% if loop.index != 1 %}
  <div class="modal fade" id="removeModal{{ participant.user_id }}" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">
            <i class="fas fa-exclamation-triangle"></i> Удаление участника
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Вы уверены, что хотите удалить <strong>{{ participant.username }}</strong> из команды?</p>
          <p class="text-danger">Участник потеряет доступ к команде и не сможет участвовать в мероприятиях от её имени.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Отмена
          </button>
          <form action="/teams/{{ team.team_id }}/remove/{{ participant.user_id }}" method="post" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-danger">
              <i class="fas fa-user-minus"></i> Удалить участника
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

<!-- Модальное окно удаления команды -->
<div class="modal fade" id="deleteTeamModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">
          <i class="fas fa-exclamation-triangle"></i> Удаление команды
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Вы уверены, что хотите удалить команду <strong>{{ team.name }}</strong>?</p>
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle"></i> 
          <strong>Внимание!</strong> Это действие нельзя отменить. Будут удалены:
          <ul class="mb-0 mt-2">
            <li>Все участники команды</li>
            <li>История участия в мероприятиях</li>
            <li>Рейтинг команды</li>
            <li>Все связанные данные</li>
          </ul>
        </div>
        
        <div class="mb-3">
          <label for="confirmDelete" class="form-label">
            Для подтверждения введите название команды: <strong>{{ team.name }}</strong>
          </label>
          <input type="text" class="form-control" id="confirmDelete" placeholder="Введите название команды">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Отмена
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled onclick="deleteTeam()">
          <i class="fas fa-trash"></i> Удалить команду навсегда
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Проверка подтверждения удаления команды
document.getElementById('confirmDelete').addEventListener('input', function() {
  const teamName = '{{ team.name }}';
  const inputValue = this.value;
  const confirmBtn = document.getElementById('confirmDeleteBtn');
  
  if (inputValue === teamName) {
    confirmBtn.disabled = false;
  } else {
    confirmBtn.disabled = true;
  }
});

function deleteTeam() {
  // Отправляем форму удаления команды
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/teams/{{ team.team_id }}/delete';
  
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrf_token';
  csrfInput.value = '{{ csrf_token }}';
  
  form.appendChild(csrfInput);
  document.body.appendChild(form);
  form.submit();
}
</script>
{% endblock %}