{% extends "base.html" %}
{% block title %}Редактирование команды — Sound Party{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Главная</a></li>
    <li class="breadcrumb-item"><a href="/admin">Панель администратора</a></li>
    <li class="breadcrumb-item"><a href="/admin/teams">Команды</a></li>
    <li class="breadcrumb-item active" aria-current="page">Редактирование</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>
        <i class="fas fa-users-cog"></i> Редактирование команды
      </h1>
      <div>
        <a href="/teams/{{ team.team_id }}" class="btn btn-outline-info me-2">
          <i class="fas fa-eye"></i> Просмотр
        </a>
        <a href="/admin/teams" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Назад
        </a>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-edit"></i> Команда: {{ team.name }}
        </h5>
      </div>
      <div class="card-body">
        <form action="/admin/teams/{{ team.team_id }}/edit" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          
          <div class="row">
            <div class="col-md-8 mb-3">
              <label for="name" class="form-label">Название команды *</label>
              <input type="text" class="form-control" id="name" name="name" 
                     value="{{ team.name }}" required>
              <small class="text-muted">Уникальное название команды</small>
            </div>
            
            <div class="col-md-4 mb-3">
              <label for="rating" class="form-label">Рейтинг *</label>
              <input type="number" class="form-control" id="rating" name="rating" 
                     value="{{ team.rating }}" required>
              <small class="text-muted">Очки команды</small>
            </div>
          </div>
          
          <!-- Информация о рейтинге -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6><i class="fas fa-chart-line"></i> Рейтинговая информация</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <p><strong>Текущий рейтинг:</strong> {{ team.rating }} очков</p>
                    </div>
                    <div class="col-md-4">
                      <p><strong>Категория:</strong> 
                        <span class="badge bg-{% if team.rating >= 1000 %}danger{% elif team.rating >= 500 %}warning{% elif team.rating >= 100 %}primary{% else %}secondary{% endif %}">
                          {% if team.rating >= 1000 %}Мастер{% elif team.rating >= 500 %}Эксперт{% elif team.rating >= 100 %}Продвинутый{% else %}Новичок{% endif %}
                        </span>
                      </p>
                    </div>
                    <div class="col-md-4">
                      <p><strong>Позиция в рейтинге:</strong> #<span id="ratingPosition">-</span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Предупреждение об изменении рейтинга -->
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>Внимание!</strong> Изменение рейтинга команды влияет на её позицию в общем рейтинге. 
            Обычно рейтинг изменяется автоматически по результатам мероприятий.
          </div>
          
          <!-- Дополнительная информация -->
          <div class="row">
            <div class="col-12">
              <div class="card bg-info text-white">
                <div class="card-body">
                  <h6><i class="fas fa-info-circle"></i> Информация о команде</h6>
                  <div class="row">
                    <div class="col-md-3">
                      <p><strong>ID команды:</strong> {{ team.team_id }}</p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Участников:</strong> {{ team.participant_count or 0 }}</p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Мероприятий:</strong> {{ team.events_count or 0 }}</p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Побед:</strong> {{ team.wins_count or 0 }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <a href="/admin/teams" class="btn btn-secondary">
              <i class="fas fa-times"></i> Отмена
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Сохранить изменения
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Дополнительные действия -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-users"></i> Участники команды</h6>
          </div>
          <div class="card-body">
            <p class="text-muted">Управление участниками команды</p>
            <a href="/admin/teams/{{ team.team_id }}/members" class="btn btn-outline-info btn-sm">
              <i class="fas fa-list"></i> Показать участников
            </a>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-trophy"></i> История команды</h6>
          </div>
          <div class="card-body">
            <p class="text-muted">Результаты участия в мероприятиях</p>
            <a href="/admin/results?team={{ team.team_id }}" class="btn btn-outline-success btn-sm">
              <i class="fas fa-chart-line"></i> Показать результаты
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Операции с рейтингом -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card border-warning">
          <div class="card-header bg-warning">
            <h6 class="mb-0"><i class="fas fa-tools"></i> Операции с рейтингом</h6>
          </div>
          <div class="card-body">
            <p>Быстрые операции для корректировки рейтинга команды:</p>
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-success btn-sm" onclick="adjustRating(100)">
                <i class="fas fa-plus"></i> +100
              </button>
              <button type="button" class="btn btn-outline-success btn-sm" onclick="adjustRating(50)">
                <i class="fas fa-plus"></i> +50
              </button>
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="adjustRating(-50)">
                <i class="fas fa-minus"></i> -50
              </button>
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="adjustRating(-100)">
                <i class="fas fa-minus"></i> -100
              </button>
              <button type="button" class="btn btn-outline-warning btn-sm" onclick="resetRating()">
                <i class="fas fa-undo"></i> Сбросить
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Корректировка рейтинга
function adjustRating(amount) {
  const ratingInput = document.getElementById('rating');
  const currentRating = parseInt(ratingInput.value) || 0;
  const newRating = Math.max(0, currentRating + amount);
  
  if (confirm(`Изменить рейтинг с ${currentRating} на ${newRating}?`)) {
    ratingInput.value = newRating;
    updateRatingInfo();
  }
}

function resetRating() {
  if (confirm('Сбросить рейтинг команды до 0?')) {
    document.getElementById('rating').value = 0;
    updateRatingInfo();
  }
}

// Обновление информации о рейтинге
function updateRatingInfo() {
  const rating = parseInt(document.getElementById('rating').value) || 0;
  
  // Обновляем категорию
  const badges = document.querySelectorAll('.badge');
  badges.forEach(badge => {
    if (badge.textContent.includes('Мастер') || badge.textContent.includes('Эксперт') || 
        badge.textContent.includes('Продвинутый') || badge.textContent.includes('Новичок')) {
      
      let category, className;
      if (rating >= 1000) {
        category = 'Мастер';
        className = 'bg-danger';
      } else if (rating >= 500) {
        category = 'Эксперт';
        className = 'bg-warning';
      } else if (rating >= 100) {
        category = 'Продвинутый';
        className = 'bg-primary';
      } else {
        category = 'Новичок';
        className = 'bg-secondary';
      }
      
      badge.className = `badge ${className}`;
      badge.textContent = category;
    }
  });
}

// Валидация рейтинга
document.getElementById('rating').addEventListener('input', function() {
  const value = parseInt(this.value);
  
  if (value < 0) {
    this.value = 0;
  }
  
  if (value > 10000) {
    if (!confirm('Очень высокий рейтинг (' + value + '). Продолжить?')) {
      this.value = 1000;
    }
  }
  
  updateRatingInfo();
});

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
  updateRatingInfo();
});
</script>
{% endblock %}