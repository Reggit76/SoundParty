{% extends "base.html" %}
{% block title %}Управление результатами — Sound Party{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Главная</a></li>
    <li class="breadcrumb-item"><a href="/admin">Панель администратора</a></li>
    <li class="breadcrumb-item active" aria-current="page">Результаты</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Уведомления -->
{% if request.query_params.get('success') == 'added' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> Результат успешно добавлен!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="fas fa-trophy"></i> Управление результатами
  </h1>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addResultModal">
    <i class="fas fa-plus"></i> Добавить результат
  </button>
</div>

<!-- Статистика -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card text-white bg-primary">
      <div class="card-body text-center">
        <h3>{{ events|length }}</h3>
        <p class="mb-0">Мероприятий</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-success">
      <div class="card-body text-center">
        <h3>{{ events|selectattr('status', 'equalto', 'завершено')|list|length }}</h3>
        <p class="mb-0">Завершено</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-info">
      <div class="card-body text-center">
        <h3>{{ teams|length }}</h3>
        <p class="mb-0">Команд</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-warning">
      <div class="card-body text-center">
        <h3>0</h3>
        <p class="mb-0">Результатов</p>
      </div>
    </div>
  </div>
</div>

<!-- Список мероприятий с результатами -->
<div class="row">
  {% for event in events %}
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">{{ event.description }}</h6>
        <span class="badge bg-{% if event.status == 'завершено' %}success{% elif event.status == 'в процессе' %}warning{% else %}secondary{% endif %}">
          {{ event.status }}
        </span>
      </div>
      <div class="card-body">
        <p class="text-muted">
          <i class="fas fa-calendar"></i> {{ event.date }}<br>
          <i class="fas fa-map-marker-alt"></i> {{ event.venue_name }}
        </p>
        
        {% if event.status == 'завершено' %}
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-success btn-sm" 
                    onclick="addResultToEvent({{ event.event_id }}, '{{ event.description }}')">
              <i class="fas fa-plus"></i> Добавить результат
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" 
                    onclick="viewResults({{ event.event_id }})">
              <i class="fas fa-list"></i> Просмотреть результаты
            </button>
          </div>
        {% else %}
          <div class="alert alert-warning">
            <i class="fas fa-clock"></i> Мероприятие не завершено
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Модальное окно добавления результата -->
<div class="modal fade" id="addResultModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-trophy"></i> Добавить результат
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/admin/results/add" method="post">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          
          <div class="mb-3">
            <label for="event_id" class="form-label">Мероприятие *</label>
            <select class="form-select" id="event_id" name="event_id" required>
              <option value="">Выберите мероприятие</option>
              {% for event in events %}
                {% if event.status == 'завершено' %}
                  <option value="{{ event.event_id }}">{{ event.description }} ({{ event.date }})</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="team_id" class="form-label">Команда *</label>
            <select class="form-select" id="team_id" name="team_id" required>
              <option value="">Выберите команду</option>
              {% for team in teams %}
                <option value="{{ team.team_id }}">{{ team.name }} (рейтинг: {{ team.rating }})</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="score" class="form-label">Баллы *</label>
            <input type="number" class="form-control" id="score" name="score" min="0" required>
            <small class="text-muted">Количество баллов, которые получила команда</small>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> 
            Баллы будут автоматически добавлены к рейтингу команды
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Отмена
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Добавить результат
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Модальное окно просмотра результатов -->
<div class="modal fade" id="viewResultsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-list"></i> Результаты мероприятия
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="resultsContent">
        <!-- Содержимое загружается динамически -->
      </div>
    </div>
  </div>
</div>

<script>
function addResultToEvent(eventId, eventName) {
  const modal = new bootstrap.Modal(document.getElementById('addResultModal'));
  document.getElementById('event_id').value = eventId;
  modal.show();
}

function viewResults(eventId) {
  const modal = new bootstrap.Modal(document.getElementById('viewResultsModal'));
  document.getElementById('resultsContent').innerHTML = `
    <div class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Загрузка...</span>
      </div>
      <p>Загрузка результатов...</p>
    </div>
  `;
  modal.show();
  
  // Здесь можно загрузить результаты через AJAX
  setTimeout(() => {
    document.getElementById('resultsContent').innerHTML = `
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Место</th>
              <th>Команда</th>
              <th>Баллы</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="badge bg-warning"><i class="fas fa-trophy"></i> 1</span></td>
              <td>Команда А</td>
              <td>100</td>
            </tr>
            <tr>
              <td><span class="badge bg-secondary"><i class="fas fa-medal"></i> 2</span></td>
              <td>Команда Б</td>
              <td>80</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
  }, 1000);
}

// Валидация формы
document.querySelector('form').addEventListener('submit', function(e) {
  const eventId = document.getElementById('event_id').value;
  const teamId = document.getElementById('team_id').value;
  const score = document.getElementById('score').value;
  
  if (!eventId || !teamId || !score) {
    e.preventDefault();
    alert('Пожалуйста, заполните все обязательные поля');
  }
  
  if (parseInt(score) < 0) {
    e.preventDefault();
    alert('Баллы не могут быть отрицательными');
  }
});
</script>
{% endblock %}