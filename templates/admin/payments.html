{% extends "base.html" %}
{% block title %}Управление платежами — Sound Party{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Главная</a></li>
    <li class="breadcrumb-item"><a href="/admin">Панель администратора</a></li>
    <li class="breadcrumb-item active" aria-current="page">Платежи</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Уведомления -->
{% if request.query_params.get('success') == 'updated' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle"></i> Статус платежа успешно обновлен!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="fas fa-credit-card"></i> Управление платежами
  </h1>
  <div>
    <span class="badge bg-info me-2">Всего: {{ payments|length }}</span>
    <button type="button" class="btn btn-success" onclick="exportPayments()">
      <i class="fas fa-download"></i> Экспорт
    </button>
  </div>
</div>

<!-- Статистика платежей -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card text-white bg-success">
      <div class="card-body text-center">
        <h3>{{ payments|selectattr('payment_status', 'equalto', 'оплачено')|list|length }}</h3>
        <p class="mb-0">Оплачено</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-warning">
      <div class="card-body text-center">
        <h3>{{ payments|selectattr('payment_status', 'equalto', 'не оплачено')|list|length }}</h3>
        <p class="mb-0">Ожидают оплаты</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-danger">
      <div class="card-body text-center">
        <h3>{{ payments|selectattr('payment_status', 'equalto', 'отменено')|list|length }}</h3>
        <p class="mb-0">Отменено</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-primary">
      <div class="card-body text-center">
        <h3>{{ payments|sum(attribute='total_amount')|round(2) }}</h3>
        <p class="mb-0">Общая сумма ₽</p>
      </div>
    </div>
  </div>
</div>

<!-- Фильтры -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row">
      <div class="col-md-3">
        <input type="text" class="form-control" id="searchInput" placeholder="Поиск по ID или команде..." onkeyup="filterPayments()">
      </div>
      <div class="col-md-3">
        <select class="form-select" id="statusFilter" onchange="filterPayments()">
          <option value="">Все статусы</option>
          <option value="оплачено">Оплачено</option>
          <option value="не оплачено">Не оплачено</option>
          <option value="отменено">Отменено</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" id="typeFilter" onchange="filterPayments()">
          <option value="">Все типы</option>
          <option value="банковская карта">Банковская карта</option>
          <option value="наличные">Наличные</option>
          <option value="перевод">Перевод</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
          <i class="fas fa-times"></i> Очистить
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Таблица платежей -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Заявка</th>
            <th>Команда</th>
            <th>Тип платежа</th>
            <th>Сумма</th>
            <th>Статус</th>
            <th>Дата платежа</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="paymentsTableBody">
          {% for payment in payments %}
          <tr data-search="{{ payment.payment_id }} {{ payment.team_name|lower if payment.team_name else '' }}" 
              data-status="{{ payment.payment_status }}" 
              data-type="{{ payment.payment_type }}">
            <td>
              <span class="badge bg-secondary">#{{ payment.payment_id }}</span>
            </td>
            <td>
              <a href="/admin/bookings?id={{ payment.booking_id }}" class="text-decoration-none">
                Заявка #{{ payment.booking_id }}
              </a>
            </td>
            <td>
              <i class="fas fa-users text-muted me-1"></i>
              {{ payment.team_name or 'Неизвестно' }}
            </td>
            <td>
              {% if payment.payment_type == "банковская карта" %}
                <i class="fas fa-credit-card text-primary"></i>
              {% elif payment.payment_type == "наличные" %}
                <i class="fas fa-money-bill text-success"></i>
              {% else %}
                <i class="fas fa-exchange-alt text-info"></i>
              {% endif %}
              {{ payment.payment_type }}
            </td>
            <td>
              <strong>{{ payment.total_amount }} ₽</strong>
            </td>
            <td>
              {% if payment.payment_status == "оплачено" %}
                <span class="badge bg-success">
                  <i class="fas fa-check"></i> Оплачено
                </span>
              {% elif payment.payment_status == "отменено" %}
                <span class="badge bg-danger">
                  <i class="fas fa-times"></i> Отменено
                </span>
              {% else %}
                <span class="badge bg-warning">
                  <i class="fas fa-clock"></i> Не оплачено
                </span>
              {% endif %}
            </td>
            <td>
              {% if payment.payment_date %}
                {{ payment.payment_date }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewPayment({{ payment.payment_id }})">
                  <i class="fas fa-eye"></i>
                </button>
                {% if payment.payment_status != "оплачено" %}
                <button type="button" class="btn btn-sm btn-outline-success" 
                        data-bs-toggle="modal" 
                        data-bs-target="#updateStatusModal{{ payment.payment_id }}">
                  <i class="fas fa-check"></i>
                </button>
                {% endif %}
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="editPayment({{ payment.payment_id }})">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Модальные окна для обновления статуса -->
{% for payment in payments %}
  {% if payment.payment_status != "оплачено" %}
  <div class="modal fade" id="updateStatusModal{{ payment.payment_id }}" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-edit"></i> Обновление статуса платежа
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Платеж:</strong> #{{ payment.payment_id }}</p>
          <p><strong>Сумма:</strong> {{ payment.total_amount }} ₽</p>
          <p><strong>Тип:</strong> {{ payment.payment_type }}</p>
          <p><strong>Текущий статус:</strong> 
            <span class="badge bg-{% if payment.payment_status == 'не оплачено' %}warning{% else %}danger{% endif %}">
              {{ payment.payment_status }}
            </span>
          </p>
          
          <form action="/admin/payments/{{ payment.payment_id }}/update_status" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            
            <div class="mb-3">
              <label for="status{{ payment.payment_id }}" class="form-label">Новый статус:</label>
              <select class="form-select" id="status{{ payment.payment_id }}" name="status" required>
                <option value="">Выберите статус</option>
                <option value="оплачено">Оплачено</option>
                <option value="отменено">Отменено</option>
                <option value="не оплачено">Не оплачено</option>
              </select>
            </div>
            
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 
              При изменении статуса на "Оплачено" будет автоматически установлена текущая дата платежа.
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times"></i> Отмена
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Обновить статус
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

<!-- Модальное окно просмотра платежа -->
<div class="modal fade" id="viewPaymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-receipt"></i> Детали платежа
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="paymentDetails">
        <!-- Содержимое загружается динамически -->
      </div>
    </div>
  </div>
</div>

<script>
function filterPayments() {
  const searchInput = document.getElementById('searchInput').value.toLowerCase();
  const statusFilter = document.getElementById('statusFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
  const rows = document.querySelectorAll('#paymentsTableBody tr');
  
  rows.forEach(row => {
    const searchText = row.dataset.search;
    const status = row.dataset.status;
    const type = row.dataset.type;
    
    let showRow = true;
    
    // Поиск
    if (searchInput && !searchText.includes(searchInput)) {
      showRow = false;
    }
    
    // Фильтр по статусу
    if (statusFilter && status !== statusFilter) {
      showRow = false;
    }
    
    // Фильтр по типу
    if (typeFilter && type !== typeFilter) {
      showRow = false;
    }
    
    row.style.display = showRow ? '' : 'none';
  });
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('typeFilter').value = '';
  filterPayments();
}

function viewPayment(paymentId) {
  const modal = new bootstrap.Modal(document.getElementById('viewPaymentModal'));
  document.getElementById('paymentDetails').innerHTML = `
    <div class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Загрузка...</span>
      </div>
      <p>Загрузка данных платежа #${paymentId}...</p>
    </div>
  `;
  modal.show();
  
  // Здесь можно загрузить детальную информацию через AJAX
  setTimeout(() => {
    document.getElementById('paymentDetails').innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6>Основная информация</h6>
          <p><strong>ID платежа:</strong> #${paymentId}</p>
          <p><strong>Дата создания:</strong> ${new Date().toLocaleDateString()}</p>
          <p><strong>Тип платежа:</strong> Банковская карта</p>
        </div>
        <div class="col-md-6">
          <h6>Финансовая информация</h6>
          <p><strong>Сумма:</strong> 1500 ₽</p>
          <p><strong>Статус:</strong> <span class="badge bg-success">Оплачено</span></p>
          <p><strong>Дата оплаты:</strong> ${new Date().toLocaleDateString()}</p>
        </div>
      </div>
    `;
  }, 1000);
}

function editPayment(paymentId) {
  alert('Редактирование платежа #' + paymentId);
}

function exportPayments() {
  const paymentsData = {
    timestamp: new Date().toISOString(),
    total_payments: {{ payments|length }},
    paid_count: {{ payments|selectattr('payment_status', 'equalto', 'оплачено')|list|length }},
    pending_count: {{ payments|selectattr('payment_status', 'equalto', 'не оплачено')|list|length }},
    cancelled_count: {{ payments|selectattr('payment_status', 'equalto', 'отменено')|list|length }},
    total_amount: {{ payments|sum(attribute='total_amount') }},
    payments: {{ payments | tojson }}
  };
  
  const content = JSON.stringify(paymentsData, null, 2);
  const blob = new Blob([content], { type: 'application/json' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'payments_export_' + new Date().toISOString().split('T')[0] + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
  
  // Показываем уведомление
  const alert = document.createElement('div');
  alert.className = 'alert alert-success alert-dismissible fade show';
  alert.innerHTML = `
    <i class="fas fa-download"></i> Данные о платежах успешно экспортированы!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.querySelector('.container').prepend(alert);
}
</script>
{% endblock %}