{% extends "base.html" %}
{% block title %}Отчеты — Sound Party{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Главная</a></li>
    <li class="breadcrumb-item"><a href="/admin">Панель администратора</a></li>
    <li class="breadcrumb-item active" aria-current="page">Отчеты</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="fas fa-chart-bar"></i> Отчеты и аналитика
  </h1>
  <div>
    <button type="button" class="btn btn-success" onclick="exportReport()">
      <i class="fas fa-download"></i> Экспорт данных
    </button>
  </div>
</div>

<!-- Общая статистика -->
<div class="row g-4 mb-4">
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <i class="fas fa-users fa-2x text-primary mb-2"></i>
        <h3 class="text-primary">{{ stats.users_count }}</h3>
        <p class="text-muted mb-0">Пользователей</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <i class="fas fa-calendar-alt fa-2x text-success mb-2"></i>
        <h3 class="text-success">{{ stats.events_count }}</h3>
        <p class="text-muted mb-0">Мероприятий</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <i class="fas fa-user-friends fa-2x text-info mb-2"></i>
        <h3 class="text-info">{{ stats.teams_count }}</h3>
        <p class="text-muted mb-0">Команд</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <i class="fas fa-clipboard-list fa-2x text-warning mb-2"></i>
        <h3 class="text-warning">{{ stats.bookings_count }}</h3>
        <p class="text-muted mb-0">Заявок</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <i class="fas fa-building fa-2x text-secondary mb-2"></i>
        <h3 class="text-secondary">{{ stats.venues_count }}</h3>
        <p class="text-muted mb-0">Площадок</p>
      </div>
    </div>
  </div>
  
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <i class="fas fa-credit-card fa-2x text-danger mb-2"></i>
        <h3 class="text-danger">{{ stats.payments_count }}</h3>
        <p class="text-muted mb-0">Платежей</p>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Распределение пользователей по ролям -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-user-tag"></i> Пользователи по ролям</h5>
      </div>
      <div class="card-body">
        <canvas id="usersChart" width="400" height="200"></canvas>
        <div class="mt-3">
          <div class="row text-center">
            <div class="col-4">
              <span class="badge bg-danger">{{ stats.admin_count }}</span>
              <p class="text-muted mb-0">Администраторы</p>
            </div>
            <div class="col-4">
              <span class="badge bg-warning">{{ stats.organizer_count }}</span>
              <p class="text-muted mb-0">Организаторы</p>
            </div>
            <div class="col-4">
              <span class="badge bg-info">{{ stats.participant_count }}</span>
              <p class="text-muted mb-0">Участники</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Статистика платежей -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Статистика платежей</h5>
      </div>
      <div class="card-body">
        <canvas id="paymentsChart" width="400" height="200"></canvas>
        <div class="mt-3">
          <div class="row text-center">
            <div class="col-6">
              <span class="badge bg-success">{{ stats.paid_payments }}</span>
              <p class="text-muted mb-0">Оплачено</p>
            </div>
            <div class="col-6">
              <span class="badge bg-warning">{{ stats.pending_payments }}</span>
              <p class="text-muted mb-0">Ожидают оплаты</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Топ команд -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-trophy"></i> Топ команд по рейтингу</h5>
      </div>
      <div class="card-body">
        {% if top_teams %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Место</th>
                  <th>Команда</th>
                  <th>Рейтинг</th>
                </tr>
              </thead>
              <tbody>
                {% for team in top_teams %}
                <tr>
                  <td>
                    {% if loop.index == 1 %}
                      <i class="fas fa-trophy text-warning"></i>
                    {% elif loop.index == 2 %}
                      <i class="fas fa-medal text-secondary"></i>
                    {% elif loop.index == 3 %}
                      <i class="fas fa-medal text-danger"></i>
                    {% else %}
                      {{ loop.index }}
                    {% endif %}
                  </td>
                  <td>{{ team.name }}</td>
                  <td><span class="badge bg-primary">{{ team.rating }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">Нет данных о командах</p>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Активность по мероприятиям -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Активность по мероприятиям</h5>
      </div>
      <div class="card-body">
        {% if event_stats %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Мероприятие</th>
                  <th>Заявок</th>
                  <th>Статус</th>
                </tr>
              </thead>
              <tbody>
                {% for item in event_stats %}
                <tr>
                  <td>{{ item.event.description }}</td>
                  <td><span class="badge bg-info">{{ item.bookings_count }}</span></td>
                  <td>
                    <span class="badge bg-{% if item.event.status == 'анонс' %}success{% elif item.event.status == 'в процессе' %}warning{% else %}secondary{% endif %}">
                      {{ item.event.status }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">Нет данных о мероприятиях</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Детальные отчеты -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-file-alt"></i> Генерация отчетов</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="d-grid">
              <button type="button" class="btn btn-outline-primary" onclick="generateReport('users')">
                <i class="fas fa-users"></i><br>
                Отчет по пользователям
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <div class="d-grid">
              <button type="button" class="btn btn-outline-success" onclick="generateReport('events')">
                <i class="fas fa-calendar-alt"></i><br>
                Отчет по мероприятиям
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <div class="d-grid">
              <button type="button" class="btn btn-outline-info" onclick="generateReport('teams')">
                <i class="fas fa-user-friends"></i><br>
                Отчет по командам
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <div class="d-grid">
              <button type="button" class="btn btn-outline-warning" onclick="generateReport('financial')">
                <i class="fas fa-money-bill-wave"></i><br>
                Финансовый отчет
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Включаем Chart.js из CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// График распределения пользователей по ролям
const usersCtx = document.getElementById('usersChart').getContext('2d');
new Chart(usersCtx, {
    type: 'doughnut',
    data: {
        labels: ['Администраторы', 'Организаторы', 'Участники'],
        datasets: [{
            data: [{{ stats.admin_count }}, {{ stats.organizer_count }}, {{ stats.participant_count }}],
            backgroundColor: ['#dc3545', '#ffc107', '#17a2b8']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// График статистики платежей
const paymentsCtx = document.getElementById('paymentsChart').getContext('2d');
new Chart(paymentsCtx, {
    type: 'doughnut',
    data: {
        labels: ['Оплачено', 'Ожидают оплаты'],
        datasets: [{
            data: [{{ stats.paid_payments }}, {{ stats.pending_payments }}],
            backgroundColor: ['#28a745', '#ffc107']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

function generateReport(type) {
    const reportData = {
        type: type,
        timestamp: new Date().toISOString(),
        stats: {
            users: {{ stats.users_count }},
            events: {{ stats.events_count }},
            teams: {{ stats.teams_count }},
            bookings: {{ stats.bookings_count }},
            payments: {{ stats.payments_count }}
        }
    };
    
    let filename = '';
    let content = '';
    
    switch(type) {
        case 'users':
            filename = 'users_report.json';
            content = JSON.stringify({
                ...reportData,
                breakdown: {
                    administrators: {{ stats.admin_count }},
                    organizers: {{ stats.organizer_count }},
                    participants: {{ stats.participant_count }}
                }
            }, null, 2);
            break;
            
        case 'events':
            filename = 'events_report.json';
            content = JSON.stringify({
                ...reportData,
                events_stats: {{ event_stats | tojson }}
            }, null, 2);
            break;
            
        case 'teams':
            filename = 'teams_report.json';
            content = JSON.stringify({
                ...reportData,
                top_teams: {{ top_teams | tojson }}
            }, null, 2);
            break;
            
        case 'financial':
            filename = 'financial_report.json';
            content = JSON.stringify({
                ...reportData,
                payments: {
                    total: {{ stats.payments_count }},
                    paid: {{ stats.paid_payments }},
                    pending: {{ stats.pending_payments }}
                }
            }, null, 2);
            break;
    }
    
    // Скачиваем файл
    const blob = new Blob([content], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Показываем уведомление
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-download"></i> Отчет "${filename}" успешно сгенерирован и скачан!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').prepend(alert);
}

function exportReport() {
    const allData = {
        timestamp: new Date().toISOString(),
        stats: {{ stats | tojson }},
        top_teams: {{ top_teams | tojson }},
        event_stats: {{ event_stats | tojson }}
    };
    
    const content = JSON.stringify(allData, null, 2);
    const blob = new Blob([content], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sound_party_full_report.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Показываем уведомление
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-download"></i> Полный отчет успешно экспортирован!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').prepend(alert);
}
</script>

<style>
.card-body canvas {
    max-height: 200px;
}
</style>
{% endblock %}